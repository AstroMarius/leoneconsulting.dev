---
interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<form id="pre-call-form" class={`space-y-6 ${className}`}>
  <!-- Nome -->
  <div>
    <label for="name" class="block text-sm font-semibold text-gray-900 mb-2">
      Nome *
    </label>
    <input
      type="text"
      id="name"
      name="name"
      required
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
      placeholder="Il tuo nome"
    />
  </div>

  <!-- Email -->
  <div>
    <label for="email" class="block text-sm font-semibold text-gray-900 mb-2">
      Email *
    </label>
    <input
      type="email"
      id="email"
      name="email"
      required
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
      placeholder="email@example.com"
    />
  </div>

  <!-- Obiettivo -->
  <div>
    <label for="objective" class="block text-sm font-semibold text-gray-900 mb-2">
      Qual è il tuo obiettivo principale? *
    </label>
    <select
      id="objective"
      name="objective"
      required
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
    >
      <option value="">Seleziona un'opzione</option>
      <option value="audit">Validare fattibilità di un'idea o progetto tech/AI (Audit)</option>
      <option value="mvp">Creare un prototipo o MVP funzionante (MVP Sprint)</option>
      <option value="data-pipeline">Automatizzare report e centralizzare dati (Data Pipeline)</option>
      <option value="improvement">Migliorare/scalare sistema esistente</option>
      <option value="other">Altro</option>
    </select>
  </div>

  <!-- Situazione Attuale -->
  <div>
    <label for="situation" class="block text-sm font-semibold text-gray-900 mb-2">
      Descrivi brevemente la tua situazione attuale *
    </label>
    <textarea
      id="situation"
      name="situation"
      required
      rows="4"
      maxlength="300"
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
      placeholder="Es: Abbiamo dati in 3 sistemi diversi (ERP, CRM, Excel) e facciamo report manuali. Vorremmo automatizzare."
    ></textarea>
    <p class="text-sm text-gray-500 mt-1">Max 300 caratteri</p>
  </div>

  <!-- Dati Esistenti -->
  <div>
    <label for="data-status" class="block text-sm font-semibold text-gray-900 mb-2">
      Hai già dati o sistemi tecnici esistenti? *
    </label>
    <select
      id="data-status"
      name="dataStatus"
      required
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
    >
      <option value="">Seleziona un'opzione</option>
      <option value="none">No, partiamo da zero</option>
      <option value="incomplete">Sì, ma sono disorganizzati o incompleti</option>
      <option value="need-integration">Sì, abbiamo dati e sistemi ma manca integrazione</option>
      <option value="advanced">Sì, abbiamo già infrastruttura avanzata</option>
    </select>
  </div>

  <!-- Timeline -->
  <div>
    <label for="timeline" class="block text-sm font-semibold text-gray-900 mb-2">
      Qual è la tua timeline ideale? *
    </label>
    <select
      id="timeline"
      name="timeline"
      required
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
    >
      <option value="">Seleziona un'opzione</option>
      <option value="urgent">Urgente (entro 1 mese)</option>
      <option value="short">Breve termine (1-3 mesi)</option>
      <option value="medium">Medio termine (3-6 mesi)</option>
      <option value="long">Lungo termine (6+ mesi), sto solo esplorando</option>
    </select>
  </div>

  <!-- Budget (opzionale) -->
  <div>
    <label for="budget" class="block text-sm font-semibold text-gray-900 mb-2">
      Hai un budget allocato per questo progetto? (opzionale)
    </label>
    <select
      id="budget"
      name="budget"
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
    >
      <option value="">Preferisco non specificarlo</option>
      <option value="under-3k">&lt; €3.000</option>
      <option value="3-10k">€3.000 - €10.000</option>
      <option value="10-30k">€10.000 - €30.000</option>
      <option value="30k+">€30.000+</option>
      <option value="not-defined">Non ancora definito</option>
    </select>
  </div>

  <!-- Submit Button -->
  <div class="pt-4">
    <button
      type="submit"
      class="w-full px-8 py-4 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-all transform hover:scale-105 font-semibold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Invia Richiesta
    </button>
  </div>

  <!-- Status Message -->
  <div id="form-status" class="hidden p-4 rounded-lg"></div>
</form>

<script>
  const form = document.getElementById('pre-call-form') as HTMLFormElement;
  const statusDiv = document.getElementById('form-status') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Invio in corso...';

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/pre-call', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        statusDiv.textContent = 'Grazie! Ti ricontatterò entro 24 ore.';
        statusDiv.className = 'p-4 rounded-lg bg-green-100 text-green-800 border border-green-300';
        statusDiv.classList.remove('hidden');
        form.reset();
        
        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = '/booking';
        }, 2000);
      } else {
        throw new Error('Errore durante l\'invio');
      }
    } catch (error) {
      statusDiv.textContent = 'Errore durante l\'invio. Riprova o contattami direttamente via email.';
      statusDiv.className = 'p-4 rounded-lg bg-red-100 text-red-800 border border-red-300';
      statusDiv.classList.remove('hidden');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Invia Richiesta';
    }
  });
</script>
