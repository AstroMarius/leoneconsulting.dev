---
interface Props {
  class?: string;
  lang?: 'it' | 'en';
}

const { class: className = '', lang = 'it' } = Astro.props;

const t = {
  it: {
    name: 'Nome',
    namePlaceholder: 'Il tuo nome',
    email: 'Email',
    objective: 'Qual è il risultato che vuoi ottenere?',
    selectOption: 'Seleziona l\'opzione più vicina al tuo caso',
    audit: 'Validare fattibilità di un\'idea o progetto tech/AI (Audit)',
    mvp: 'Creare un prototipo o MVP funzionante (MVP Sprint)',
    dataPipeline: 'Automatizzare report e centralizzare dati (Data Pipeline)',
    improvement: 'Migliorare o scalare sistema esistente',
    other: 'Altro',
    situation: 'Descrivi contesto attuale e blocco principale',
    situationPlaceholder: 'Es: Dati in ERP, CRM e fogli Excel non allineati; report manuali lenti; obiettivo: dashboard automatica con KPI affidabili entro 8 settimane.',
    maxChars: 'Max 300 caratteri',
    dataStatus: 'A che punto siete con dati e sistemi?',
    dataStatusNone: 'No, partiamo da zero',
    dataStatusIncomplete: 'Sì, ma sono disorganizzati o incompleti',
    dataStatusIntegration: 'Sì, abbiamo dati e sistemi ma manca integrazione',
    dataStatusAdvanced: 'Sì, abbiamo già infrastruttura avanzata',
    timeline: 'Quando vuoi vedere i primi risultati?',
    timelineUrgent: 'Urgente (entro 1 mese)',
    timelineShort: 'Breve termine (1-3 mesi)',
    timelineMedium: 'Medio termine (3-6 mesi)',
    timelineLong: 'Lungo termine (6+ mesi), sto solo esplorando',
    budget: 'Budget indicativo disponibile (opzionale, utile per proporti opzioni realistiche)',
    budgetRange1: 'Fino a CHF 3.000',
    budgetRange2: 'CHF 3.000 - CHF 7.000',
    budgetRange3: 'CHF 7.000 - CHF 12.000',
    budgetRange4: 'CHF 12.000 - CHF 20.000',
    budgetNone: 'Preferisco non specificarlo',
    budgetNotDefined: 'Non ancora definito',
    submit: 'Invia Richiesta',
    submitting: 'Invio in corso...',
    successMsg: 'Perfetto, richiesta ricevuta. Ti rispondo entro 24 ore con i prossimi step.',
    errorMsg: 'Errore durante l\'invio. Riprova oppure scrivimi direttamente via email.',
  },
  en: {
    name: 'Name',
    namePlaceholder: 'Your name',
    email: 'Email',
    objective: 'What outcome do you want to achieve?',
    selectOption: 'Select the option closest to your case',
    audit: 'Validate feasibility of a tech/AI idea or project (Audit)',
    mvp: 'Create a working prototype or MVP (MVP Sprint)',
    dataPipeline: 'Automate reports and centralize data (Data Pipeline)',
    improvement: 'Improve or scale an existing system',
    other: 'Other',
    situation: 'Describe your current context and main blocker',
    situationPlaceholder: 'E.g.: Data is split across ERP, CRM, and spreadsheets; reporting is manual and slow; goal: automated KPI dashboard in 8 weeks.',
    maxChars: 'Max 300 characters',
    dataStatus: 'What is your current data/system maturity?',
    dataStatusNone: 'No, starting from scratch',
    dataStatusIncomplete: 'Yes, but they are disorganized or incomplete',
    dataStatusIntegration: 'Yes, we have data and systems but integration is missing',
    dataStatusAdvanced: 'Yes, we already have advanced infrastructure',
    timeline: 'When do you need the first measurable results?',
    timelineUrgent: 'Urgent (within 1 month)',
    timelineShort: 'Short term (1-3 months)',
    timelineMedium: 'Medium term (3-6 months)',
    timelineLong: 'Long term (6+ months), just exploring',
    budget: 'Indicative available budget (optional, helps propose realistic options)',
    budgetRange1: 'Up to CHF 3,000',
    budgetRange2: 'CHF 3,000 - CHF 7,000',
    budgetRange3: 'CHF 7,000 - CHF 12,000',
    budgetRange4: 'CHF 12,000 - CHF 20,000',
    budgetNone: 'Prefer not to specify',
    budgetNotDefined: 'Not yet defined',
    submit: 'Send Request',
    submitting: 'Sending...',
    successMsg: 'Great, request received. I will reply within 24 hours with next steps.',
    errorMsg: 'Error sending. Please try again or contact me directly by email.',
  },
};

const text = t[lang];
---

<form id="pre-call-form" class={`space-y-6 ${className}`} data-lang={lang}>
  <div id="preselected-package" class="hidden p-3 rounded-lg bg-primary-50 border border-primary-200 text-primary-900 text-sm">
    <div class="flex items-center justify-between gap-3">
      <span id="preselected-package-text" class="font-medium"></span>
      <button
        type="button"
        id="change-preselected-package"
        class="text-primary-700 underline hover:text-primary-800 font-semibold whitespace-nowrap"
      >
        {lang === 'en' ? 'Change package' : 'Cambia pacchetto'}
      </button>
    </div>
  </div>

  <!-- Nome -->
  <div>
    <label for="name" class="block text-sm font-semibold text-gray-900 mb-2">
      {text.name} *
    </label>
    <input
      type="text"
      id="name"
      name="name"
      required
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
      placeholder={text.namePlaceholder}
    />
  </div>

  <!-- Email -->
  <div>
    <label for="email" class="block text-sm font-semibold text-gray-900 mb-2">
      {text.email} *
    </label>
    <input
      type="email"
      id="email"
      name="email"
      required
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
      placeholder="email@example.com"
    />
  </div>

  <!-- Obiettivo -->
  <div>
    <label for="objective" class="block text-sm font-semibold text-gray-900 mb-2">
      {text.objective} *
    </label>
    <select
      id="objective"
      name="objective"
      required
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
    >
      <option value="">{text.selectOption}</option>
      <option value="audit">{text.audit}</option>
      <option value="mvp">{text.mvp}</option>
      <option value="data-pipeline">{text.dataPipeline}</option>
      <option value="improvement">{text.improvement}</option>
      <option value="other">{text.other}</option>
    </select>
  </div>

  <!-- Situazione Attuale -->
  <div>
    <label for="situation" class="block text-sm font-semibold text-gray-900 mb-2">
      {text.situation} *
    </label>
    <textarea
      id="situation"
      name="situation"
      required
      rows="4"
      maxlength="300"
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
      placeholder={text.situationPlaceholder}
    ></textarea>
    <p class="text-sm text-gray-500 mt-1">{text.maxChars}</p>
  </div>

  <!-- Dati Esistenti -->
  <div>
    <label for="data-status" class="block text-sm font-semibold text-gray-900 mb-2">
      {text.dataStatus} *
    </label>
    <select
      id="data-status"
      name="dataStatus"
      required
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
    >
      <option value="">{text.selectOption}</option>
      <option value="none">{text.dataStatusNone}</option>
      <option value="incomplete">{text.dataStatusIncomplete}</option>
      <option value="need-integration">{text.dataStatusIntegration}</option>
      <option value="advanced">{text.dataStatusAdvanced}</option>
    </select>
  </div>

  <!-- Timeline -->
  <div>
    <label for="timeline" class="block text-sm font-semibold text-gray-900 mb-2">
      {text.timeline} *
    </label>
    <select
      id="timeline"
      name="timeline"
      required
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
    >
      <option value="">{text.selectOption}</option>
      <option value="urgent">{text.timelineUrgent}</option>
      <option value="short">{text.timelineShort}</option>
      <option value="medium">{text.timelineMedium}</option>
      <option value="long">{text.timelineLong}</option>
    </select>
  </div>

  <!-- Budget (opzionale) -->
  <div>
    <label for="budget" class="block text-sm font-semibold text-gray-900 mb-2">
      {text.budget}
    </label>
    <select
      id="budget"
      name="budget"
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent transition-all"
    >
      <option value="">{text.budgetNone}</option>
      <option value="under-3k">{text.budgetRange1}</option>
      <option value="3-10k">{text.budgetRange2}</option>
      <option value="10-30k">{text.budgetRange3}</option>
      <option value="30k+">{text.budgetRange4}</option>
      <option value="not-defined">{text.budgetNotDefined}</option>
    </select>
  </div>

  <!-- Submit Button -->
  <div class="pt-4">
    <button
      type="submit"
      class="w-full px-8 py-4 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-all transform hover:scale-105 font-semibold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
    >
      {text.submit}
    </button>
  </div>

  <!-- Status Message -->
  <div id="form-status" class="hidden p-4 rounded-lg"></div>
</form>

<script>
  const form = document.getElementById('pre-call-form') as HTMLFormElement;
  const statusDiv = document.getElementById('form-status') as HTMLDivElement;
  const lang = form?.dataset.lang || 'it';

  const messages = {
    it: {
      submitting: 'Invio in corso...',
      submit: 'Invia Richiesta',
      success: 'Perfetto, richiesta ricevuta. Ti rispondo entro 24 ore con i prossimi step.',
      error: 'Errore durante l\'invio. Riprova oppure scrivimi direttamente via email.',
    },
    en: {
      submitting: 'Sending...',
      submit: 'Send Request',
      success: 'Great, request received. I will reply within 24 hours with next steps.',
      error: 'Error sending. Please try again or contact me directly by email.',
    },
  };

  const t = messages[lang as 'it' | 'en'] || messages.it;

  const objectiveByPackage: Record<string, string> = {
    'tech-audit': 'audit',
    'tech-ai-audit': 'audit',
    'mvp-sprint': 'mvp',
    'data-pipeline': 'data-pipeline',
    'data-pipeline-dashboard': 'data-pipeline',
  };

  const params = new URLSearchParams(window.location.search);
  const packageParam = params.get('package')?.toLowerCase() || '';
  const preselectedObjective = objectiveByPackage[packageParam];

  if (preselectedObjective) {
    const objectiveSelect = form?.querySelector('#objective') as HTMLSelectElement | null;
    if (objectiveSelect) {
      objectiveSelect.value = preselectedObjective;

      const preselectedPackageBox = form?.querySelector('#preselected-package') as HTMLDivElement | null;
      const preselectedPackageText = form?.querySelector('#preselected-package-text') as HTMLSpanElement | null;
      const selectedText = objectiveSelect.options[objectiveSelect.selectedIndex]?.text;
      if (preselectedPackageBox && preselectedPackageText && selectedText) {
        const prefix = lang === 'en' ? 'Pre-selected package:' : 'Pacchetto pre-selezionato:';
        preselectedPackageText.textContent = `${prefix} ${selectedText}`;
        preselectedPackageBox.classList.remove('hidden');
      }

      const changePackageBtn = form?.querySelector('#change-preselected-package') as HTMLButtonElement | null;
      changePackageBtn?.addEventListener('click', () => {
        objectiveSelect.focus();
        objectiveSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
        objectiveSelect.classList.add('ring-4', 'ring-primary-300', 'ring-offset-2');
        setTimeout(() => {
          objectiveSelect.classList.remove('ring-4', 'ring-primary-300', 'ring-offset-2');
        }, 1000);
      });
    }
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = t.submitting;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/pre-call', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        statusDiv.textContent = t.success;
        statusDiv.className = 'p-4 rounded-lg bg-green-100 text-green-800 border border-green-300';
        statusDiv.classList.remove('hidden');
        form.reset();
        
        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = lang === 'en' ? '/en/booking' : '/booking';
        }, 2000);
      } else {
        throw new Error('Errore durante l\'invio');
      }
    } catch (error) {
      statusDiv.textContent = t.error;
      statusDiv.className = 'p-4 rounded-lg bg-red-100 text-red-800 border border-red-300';
      statusDiv.classList.remove('hidden');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = t.submit;
    }
  });
</script>
